<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHA Church Contribution Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .content { padding: 30px; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }
        
        .summary-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .summary-card .amount {
            font-size: 28px;
            font-weight: bold;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .connection-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }
        
        .connection-card h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #fff3cd;
            color: #856404;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .upload-area:hover {
            background: #f0f4ff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        thead {
            background: #667eea;
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
        }
        
        tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        tbody tr:hover {
            background: #f7f9fc;
        }
        
        .source-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-zelle {
            background: #e6f3ff;
            color: #0066cc;
        }
        
        .badge-cashapp {
            background: #e6ffe6;
            color: #00aa00;
        }
        
        .badge-tithly {
            background: #fff3e6;
            color: #cc6600;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        input[type="file"] { display: none; }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚õ™ PHA Church Contribution Tracker</h1>
            <p>Automated tracking via Plaid, Tithly & CashApp</p>
        </div>

        <div class="content">
            <div id="messageArea"></div>

            <!-- Google Sign-In Section -->
            <div class="section" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white;">
                <div id="signedOut" style="text-align: center;">
                    <h2 style="color: white; margin-bottom: 15px;">üîê Sign In with Google</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Sign in to save your data and sync to Google Sheets</p>
                    <div id="g_id_onload"
                         data-client_id="914138873417-pqh9ospt8s8ur6ahb1iarr57ad53m06m.apps.googleusercontent.com"
                         data-callback="handleCredentialResponse">
                    </div>
                    <div class="g_id_signin" 
                         data-type="standard"
                         data-size="large"
                         data-theme="outline"
                         data-text="sign_in_with"
                         data-shape="rectangular"
                         data-logo_alignment="left">
                    </div>
                </div>
                
                <div id="signedIn" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <img id="userPhoto" src="" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid white;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600;" id="userName"></div>
                                <div style="opacity: 0.9; font-size: 14px;" id="userEmail"></div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="signOut()" style="width: auto;">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Total Contributions</h3>
                    <div class="amount" id="totalAmount">$0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Contributors</h3>
                    <div class="amount" id="totalContributors">0</div>
                </div>
                <div class="summary-card">
                    <h3>This Month</h3>
                    <div class="amount" id="monthAmount">$0.00</div>
                </div>
            </div>

            <!-- Connections -->
            <div class="section">
                <h2>üîó Data Sources</h2>
                <div class="connection-grid">
                    <!-- Bank/Zelle -->
                    <div class="connection-card">
                        <h3>
                            <span>üè¶ Bank (Zelle)</span>
                            <span class="status-badge status-disconnected" id="bankStatus">Not Connected</span>
                        </h3>
                        <p style="color: #666; margin-bottom: 10px;">Auto-sync Zelle via Plaid</p>
                        <button class="btn btn-primary" onclick="connectBank()">
                            üîó Connect Bank
                        </button>
                        <button class="btn btn-success" onclick="syncBank()" id="syncBankBtn" style="display:none;">
                            üîÑ Sync Transactions
                        </button>
                    </div>

                    <!-- Tithly -->
                    <div class="connection-card">
                        <h3>
                            <span>üôè Tithly</span>
                            <span class="status-badge status-disconnected" id="tithlyStatus">Not Connected</span>
                        </h3>
                        <p style="color: #666; margin-bottom: 10px;">Sync online giving</p>
                        <input type="text" id="tithlyApiKey" placeholder="Tithly API Key">
                        <button class="btn btn-primary" onclick="connectTithly()">
                            üîó Connect Tithly
                        </button>
                        <button class="btn btn-success" onclick="syncTithly()" id="syncTithlyBtn" style="display:none;">
                            üîÑ Sync Giving
                        </button>
                    </div>

                    <!-- CashApp -->
                    <div class="connection-card">
                        <h3>
                            <span>üí≥ CashApp</span>
                            <span class="status-badge status-disconnected">Manual Upload</span>
                        </h3>
                        <p style="color: #666; margin-bottom: 10px;">Upload CSV statement</p>
                        <div class="upload-area" onclick="document.getElementById('cashappFile').click()">
                            <div style="font-size: 32px; margin-bottom: 10px;">üìÇ</div>
                            <div>Click to Upload CSV</div>
                        </div>
                        <input type="file" id="cashappFile" accept=".csv" onchange="handleCashApp(event)">
                    </div>
                </div>
            </div>

            <!-- Google Sheets Export -->
            <div class="section">
                <h2>üìä Google Sheets Auto-Sync</h2>
                <p style="color: #666; margin-bottom: 15px;">Automatically update your Google Sheet with contributions (Names as rows, Dates as columns)</p>
                
                <div class="connection-card" style="max-width: 600px;">
                    <input type="text" id="spreadsheetId" placeholder="Google Spreadsheet ID or full URL" style="margin-bottom: 10px;">
                    <small style="display: block; color: #666; margin-bottom: 15px;">
                        Get this from your Google Sheet URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit
                    </small>
                    
                    <button class="btn btn-primary" onclick="syncToGoogleSheets()" style="margin-right: 10px;">
                        üì§ Sync to Google Sheets Now
                    </button>
                    <button class="btn btn-secondary" onclick="setupAutoSync()">
                        ‚è∞ Enable Daily Auto-Sync
                    </button>
                    
                    <div id="sheetsStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                </div>
            </div>

            <!-- Table -->
            <div class="section">
                <h2>üìä Contributions</h2>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="exportExcel()" style="width: auto; display: inline-block; margin-right: 10px;">
                        üì• Download Excel
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()" style="width: auto; display: inline-block;">
                        üóëÔ∏è Clear All
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Source</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                                No contributions yet. Connect a source to get started!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let contributions = [];
        let plaidAccessToken = null;
        let tithlyApiKey = null;
        let googleUser = null;

        // Load data
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            updateDisplay();
            checkGoogleSignIn();
        });

        // Google Sign-In
        function handleCredentialResponse(response) {
            // Decode JWT token
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            googleUser = JSON.parse(jsonPayload);
            
            // Save to localStorage
            localStorage.setItem('googleUser', JSON.stringify(googleUser));
            
            // Update UI
            updateGoogleSignInUI();
            showMessage('success', 'Signed in as ' + googleUser.name);
        }

        function updateGoogleSignInUI() {
            if (googleUser) {
                document.getElementById('signedOut').style.display = 'none';
                document.getElementById('signedIn').style.display = 'block';
                document.getElementById('userName').textContent = googleUser.name;
                document.getElementById('userEmail').textContent = googleUser.email;
                document.getElementById('userPhoto').src = googleUser.picture;
            } else {
                document.getElementById('signedOut').style.display = 'block';
                document.getElementById('signedIn').style.display = 'none';
            }
        }

        function signOut() {
            googleUser = null;
            localStorage.removeItem('googleUser');
            updateGoogleSignInUI();
            showMessage('info', 'Signed out');
        }

        function checkGoogleSignIn() {
            const saved = localStorage.getItem('googleUser');
            if (saved) {
                googleUser = JSON.parse(saved);
                updateGoogleSignInUI();
            }
        }

        // Connect Bank via Plaid
        async function connectBank() {
            try {
                showMessage('info', 'Connecting to Plaid...');
                
                const response = await fetch('/.netlify/functions/plaid-link', {
                    method: 'POST'
                });
                
                const { link_token } = await response.json();
                
                const handler = Plaid.create({
                    token: link_token,
                    onSuccess: async (public_token) => {
                        const exchangeRes = await fetch('/.netlify/functions/plaid-exchange', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ public_token })
                        });
                        
                        const { access_token } = await exchangeRes.json();
                        plaidAccessToken = access_token;
                        localStorage.setItem('plaidAccessToken', access_token);
                        
                        document.getElementById('bankStatus').className = 'status-badge status-connected';
                        document.getElementById('bankStatus').textContent = 'Connected';
                        document.getElementById('syncBankBtn').style.display = 'block';
                        
                        showMessage('success', 'Bank connected! Click Sync to get transactions.');
                    },
                    onExit: (err) => {
                        if (err) showMessage('error', 'Connection cancelled');
                    }
                });
                
                handler.open();
            } catch (error) {
                showMessage('error', 'Failed to connect: ' + error.message);
            }
        }

        // Sync Bank Transactions
        async function syncBank() {
            if (!plaidAccessToken) {
                showMessage('error', 'Please connect bank first');
                return;
            }
            
            try {
                showMessage('info', 'Syncing transactions...');
                
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const response = await fetch('/.netlify/functions/plaid-transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        access_token: plaidAccessToken,
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                const { transactions } = await response.json();
                
                let imported = 0;
                transactions.forEach(t => {
                    if (!isDuplicate(t.name, t.amount, t.date, 'zelle')) {
                        contributions.push({
                            id: Date.now() + Math.random(),
                            ...t
                        });
                        imported++;
                    }
                });
                
                saveToStorage();
                updateDisplay();
                showMessage('success', `Imported ${imported} transaction(s)!`);
            } catch (error) {
                showMessage('error', 'Sync failed: ' + error.message);
            }
        }

        // Connect Tithly
        function connectTithly() {
            const apiKey = document.getElementById('tithlyApiKey').value.trim();
            if (!apiKey) {
                showMessage('error', 'Please enter Tithly API key');
                return;
            }
            
            tithlyApiKey = apiKey;
            localStorage.setItem('tithlyApiKey', apiKey);
            
            document.getElementById('tithlyStatus').className = 'status-badge status-connected';
            document.getElementById('tithlyStatus').textContent = 'Connected';
            document.getElementById('syncTithlyBtn').style.display = 'block';
            
            showMessage('success', 'Tithly connected!');
        }

        // Sync Tithly
        async function syncTithly() {
            if (!tithlyApiKey) {
                showMessage('error', 'Please connect Tithly first');
                return;
            }
            
            try {
                showMessage('info', 'Syncing Tithly...');
                
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const response = await fetch('/.netlify/functions/tithly-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: tithlyApiKey,
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                const { transactions } = await response.json();
                
                let imported = 0;
                transactions.forEach(t => {
                    if (!isDuplicate(t.name, t.amount, t.date, 'tithly')) {
                        contributions.push({
                            id: Date.now() + Math.random(),
                            ...t
                        });
                        imported++;
                    }
                });
                
                saveToStorage();
                updateDisplay();
                showMessage('success', `Imported ${imported} contribution(s)!`);
            } catch (error) {
                showMessage('error', 'Tithly sync failed: ' + error.message);
            }
        }

        // Handle CashApp Upload
        async function handleCashApp(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const lines = text.split('\n').filter(l => l.trim());
                
                if (lines.length < 2) {
                    showMessage('error', 'CSV file is empty');
                    return;
                }
                
                const headers = lines[0].toLowerCase().split(',');
                let imported = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    const transaction = extractFromCSV(cols, headers);
                    
                    if (transaction && !isDuplicate(transaction.name, transaction.amount, transaction.date, 'cashapp')) {
                        contributions.push({
                            id: Date.now() + Math.random(),
                            ...transaction,
                            source: 'cashapp'
                        });
                        imported++;
                    }
                }
                
                saveToStorage();
                updateDisplay();
                showMessage('success', `Imported ${imported} transaction(s)!`);
            } catch (error) {
                showMessage('error', 'Failed to parse CSV: ' + error.message);
            }
        }

        // Extract from CSV
        function extractFromCSV(cols, headers) {
            let name = '', date = '', amount = 0;
            
            headers.forEach((h, i) => {
                const val = cols[i]?.trim().replace(/"/g, '');
                if (h.includes('name') || h.includes('description') || h.includes('from')) name = val;
                if (h.includes('date')) date = val;
                if (h.includes('amount')) amount = parseFloat(val.replace(/[$,]/g, ''));
            });
            
            if (name && date && amount > 0) {
                return {
                    name: cleanName(name),
                    date: parseDate(date),
                    amount: amount
                };
            }
            return null;
        }

        // Check duplicate
        function isDuplicate(name, amount, date, source) {
            return contributions.some(c =>
                c.name === name &&
                c.amount === amount &&
                c.date === date &&
                c.source === source
            );
        }

        // Clean name
        function cleanName(name) {
            return name
                .replace(/was deposited in your account/gi, '')
                .replace(/[^a-zA-Z\s]/g, '')
                .trim()
                .replace(/\s+/g, ' ')
                .split(' ')
                .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
                .join(' ');
        }

        // Parse date
        function parseDate(dateStr) {
            try {
                if (/\d{1,2}\/\d{1,2}\/\d{2,4}/.test(dateStr)) {
                    const [m, d, y] = dateStr.split('/');
                    const year = y.length === 2 ? '20' + y : y;
                    return new Date(year, m - 1, d).toISOString().split('T')[0];
                }
                return new Date(dateStr).toISOString().split('T')[0];
            } catch {
                return new Date().toISOString().split('T')[0];
            }
        }

        // Export Excel with Monthly Tabs
        function exportExcel() {
            if (contributions.length === 0) {
                alert('No contributions to export');
                return;
            }
            
            const byMonth = {};
            contributions.forEach(c => {
                const date = new Date(c.date);
                const month = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                if (!byMonth[month]) byMonth[month] = [];
                byMonth[month].push(c);
            });
            
            const wb = XLSX.utils.book_new();
            
            Object.keys(byMonth).sort((a, b) => new Date(byMonth[b][0].date) - new Date(byMonth[a][0].date)).forEach(month => {
                const data = byMonth[month].map(c => ({
                    'Date': new Date(c.date).toLocaleDateString(),
                    'Name': c.name,
                    'Source': c.source.toUpperCase(),
                    'Amount': c.amount
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                ws['!cols'] = [{ wch: 12 }, { wch: 25 }, { wch: 12 }, { wch: 12 }];
                XLSX.utils.book_append_sheet(wb, ws, month.substring(0, 31));
            });
            
            const summary = Object.keys(byMonth).map(month => ({
                'Month': month,
                'Total': byMonth[month].reduce((sum, c) => sum + c.amount, 0),
                'Transactions': byMonth[month].length
            }));
            
            const summaryWs = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            XLSX.writeFile(wb, `PHA_Church_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        // Update Display
        function updateDisplay() {
            const total = contributions.reduce((sum, c) => sum + c.amount, 0);
            const unique = new Set(contributions.map(c => c.name)).size;
            const month = new Date().getMonth();
            const year = new Date().getFullYear();
            const monthTotal = contributions
                .filter(c => {
                    const d = new Date(c.date);
                    return d.getMonth() === month && d.getFullYear() === year;
                })
                .reduce((sum, c) => sum + c.amount, 0);
            
            document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
            document.getElementById('totalContributors').textContent = unique;
            document.getElementById('monthAmount').textContent = '$' + monthTotal.toFixed(2);
            
            const tbody = document.getElementById('tableBody');
            if (contributions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">No contributions yet.</td></tr>';
                return;
            }
            
            const sorted = [...contributions].sort((a, b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = sorted.map(c => `
                <tr>
                    <td>${new Date(c.date).toLocaleDateString()}</td>
                    <td>${c.name}</td>
                    <td><span class="source-badge badge-${c.source}">${c.source.toUpperCase()}</span></td>
                    <td>$${c.amount.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Messages
        function showMessage(type, msg) {
            const area = document.getElementById('messageArea');
            area.innerHTML = `<div class="message ${type}">${msg}</div>`;
            setTimeout(() => area.innerHTML = '', 5000);
        }

        // Storage
        function saveToStorage() {
            localStorage.setItem('contributions', JSON.stringify(contributions));
        }
        
        function loadFromStorage() {
            const stored = localStorage.getItem('contributions');
            if (stored) contributions = JSON.parse(stored);
            
            plaidAccessToken = localStorage.getItem('plaidAccessToken');
            if (plaidAccessToken) {
                document.getElementById('bankStatus').className = 'status-badge status-connected';
                document.getElementById('bankStatus').textContent = 'Connected';
                document.getElementById('syncBankBtn').style.display = 'block';
            }
            
            tithlyApiKey = localStorage.getItem('tithlyApiKey');
            if (tithlyApiKey) {
                document.getElementById('tithlyApiKey').value = tithlyApiKey;
                document.getElementById('tithlyStatus').className = 'status-badge status-connected';
                document.getElementById('tithlyStatus').textContent = 'Connected';
                document.getElementById('syncTithlyBtn').style.display = 'block';
            }
            
            const savedSpreadsheetId = localStorage.getItem('spreadsheetId');
            if (savedSpreadsheetId) {
                document.getElementById('spreadsheetId').value = savedSpreadsheetId;
            }
        }
        
        // Sync to Google Sheets
        async function syncToGoogleSheets() {
            if (contributions.length === 0) {
                showSheetsStatus('error', 'No contributions to sync');
                return;
            }
            
            let spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            if (!spreadsheetId) {
                showSheetsStatus('error', 'Please enter a Spreadsheet ID');
                return;
            }
            
            if (spreadsheetId.includes('spreadsheets/d/')) {
                const match = spreadsheetId.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (match) spreadsheetId = match[1];
            }
            
            localStorage.setItem('spreadsheetId', spreadsheetId);
            
            try {
                showSheetsStatus('info', 'Syncing to Google Sheets...');
                
                const response = await fetch('/.netlify/functions/sheets-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spreadsheetId: spreadsheetId,
                        contributions: contributions
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSheetsStatus('success', `‚úì ${result.message}`);
                    showMessage('success', 'Google Sheets updated successfully!');
                } else {
                    throw new Error(result.error || 'Sync failed');
                }
            } catch (error) {
                showSheetsStatus('error', 'Sync failed: ' + error.message);
                showMessage('error', 'Failed to sync to Google Sheets');
            }
        }
        
        function setupAutoSync() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            if (!spreadsheetId) {
                showSheetsStatus('error', 'Please enter a Spreadsheet ID first');
                return;
            }
            
            localStorage.setItem('autoSyncEnabled', 'true');
            localStorage.setItem('spreadsheetId', spreadsheetId);
            
            showSheetsStatus('success', '‚úì Auto-sync enabled! Will sync daily.');
            showMessage('success', 'Auto-sync enabled!');
        }
        
        function showSheetsStatus(type, msg) {
            const statusDiv = document.getElementById('sheetsStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = `message ${type}`;
            statusDiv.textContent = msg;
        }
        
        function clearData() {
            if (confirm('Clear all data?')) {
                contributions = [];
                saveToStorage();
                updateDisplay();
            }
        }
    </script>
</body>
</html>
